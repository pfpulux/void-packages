# Template file for 'forgejo'
pkgname=forgejo
version=1.20.5
revision=1
_forgejo_tag="1-20-5-0"
build_style=go
go_import_path=code.gitea.io/gitea
go_ldflags=" -X main.Version=${version}"
# This could be done with build options, but these are built in with the
# following justification.
#   * bindata: running with things not all in the binary is not a
#     supported distribution format by the forgejo upstream developers.
#     That mode is only supported for development of forgejo within the
#     source tree
#   * sqlite: this is likely the database that everyone will use.  Only
#     particularly large installations will want to go through the
#     effort of setting up a real database server.
#   * pam: PAM allows for authentication to varied external sources.
#     Internal authentication supports the local database, OpenID, and
#     LDAP, but basic other auth sources such as Kerberos and more
#     exotic authenticators require PAM support to be useable.
#   * tidb: This is an alternate database engine for users who would
#     rather not use SQLite3 for some reason.  It is also potentially
#     more resiliant to corrupted writes.
go_build_tags="bindata sqlite pam tidb"
hostmakedepends="go-bindata"
makedepends="sqlite-devel pam-devel"
depends="git bash"
short_desc="Self-hosted lightweight software forge"
maintainer="Pulux <pulux@pf4sh.eu>"
license="MIT"
homepage="https://forgejo.org"
changelog="https://codeberg.org/forgejo/forgejo/src/branch/forgejo/RELEASE-NOTES.md#${_forgejo_tag}"
distfiles="https://codeberg.org/forgejo/forgejo/releases/download/v${version}-0/forgejo-src-${version}-0.tar.gz"
checksum=e709c0e6403100fdef96eec8ac146c065375228b104125b9bf5ea844ea48633e
conflicts="gitea"

system_accounts="_forgejo"
_forgejo_homedir="/var/lib/forgejo"
_forgejo_shell="/bin/bash" # Proper shell needed for ssh support
make_dirs="/var/lib/forgejo 0755 _forgejo _forgejo
 /var/log/forgejo 0755 _forgejo root"
conf_files="/etc/forgejo.conf"


post_install() {
	vlicense LICENSE
	vsv forgejo
	vinstall custom/conf/app.example.ini 0640 /etc forgejo.conf
}
